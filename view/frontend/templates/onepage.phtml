<?= $this->getChildHtml() ?>

<div id="checkout" class="checkout-container">
    <section class="shipping-address">
        <div v-for="field in shippingAddress">
            <template v-if="field.type !== 'select'">
                <label :for="field.name">
                    {{ field.label }}
                </label>
                <input :type="field.type" :name="field.name" :value="field.value">
            </template>
            <template v-if="field.type === 'select'">
                <label :for="field.name">
                    {{ field.label }}
                </label>
                <select :name="field.name">
                    <option v-for="option in field.options" :value="option.value" :selected="option.selected" :disabled="option.disabled">
                        {{ option.label }}
                    </option>
                </select>
            </template>
        </div>
    </section>

    <section v-if="step !== 'success'">
        <h1>Totals</h1>
        <pre>{{ config.totalsData }}</pre>
    </section>

    <section v-if="step === 'shipping'">
        <button type="button" @click="setShippingInformation">
            Set shipping information
        </button>
    </section>

    <section v-if="step === 'billing'">
        <button @click="step = 'shipping'">
            Back
        </button>
        <button type="button" @click="makeOrder">
            Make order
        </button>
    </section>

    <section v-if="step === 'success'">
        We did it!
        <a href="/women/tops-women/jackets-women.html">
            Back to category
        </a>
    </section>
</div>

<script>
    require(['vue'], function(Vue) {
        var app = new Vue({
            el: '#checkout',
            data: {
                baseUrl: '<?= $block->getBaseUrl() ?>',
                config: <?= \Zend_Json::encode($block->getCheckoutConfig()) ?>,
                shippingAddress: shippingAddress,
                billingAddress: {},
                step: 'shipping',
                type: [
                    'checkbox',
                    'date',
                    'email',
                    'hidden',
                    'number',
                    'password',
                    'radio',
                    'select',
                    'multiselect',
                    'tel',
                    'text',
                    'textarea'
                ]
            },
            computed: {
                cartId() {
                    return this.config.quoteData.entity_id
                },
                cart() {
                    const cart = this.config.quoteData;
                    cart.items = this.config.quoteItemData;
                    return cart;
                }
            },
            methods: {
                parseJSON: function (response) {
                    return new Promise(
                        (resolve) => response.json()
                            .then((json) => resolve({
                                status: response.status,
                                ok: response.ok,
                                json
                            }))
                    )
                },
                request: function (url, params = {}) {
                    return new Promise((resolve, reject) => {
                        fetch(url, params)
                            .then(this.parseJSON)
                            .then((response) => {
                                if (response.ok) {
                                    return resolve(response.json)
                                }
                                // extract the error from the server's json
                                return reject(response.json)
                            })
                            .catch((error) => reject({
                                networkError: error.message
                            }));
                    })
                },
                setShippingInformation() {
                    this.request(
                        `${this.baseUrl}index.php/rest/V1/guest-carts/${this.cartId}/shipping-information`,
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(shippingInformation)
                        }
                    )
                        .then(response => {
                            this.config.paymentMethods = response.payment_methods;
                            this.config.totalsData = response.totals;
                            this.step = 'billing';
                        });
                },
                makeOrder() {
                    this.request(
                        `${this.baseUrl}index.php/rest/V1/guest-carts/${this.cartId}/order`,
                        {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                "paymentMethod": {
                                    "po_number": "string",
                                    "method": "checkmo",
                                    "additional_data": [
                                        "string"
                                    ],
                                    "extension_attributes": {
                                        "agreement_ids": [
                                            "string"
                                        ]
                                    }
                                }
                            })
                        }
                    )
                        .then(response => {
                            this.step = 'success';
                        })
                }
            }
        })
    });
</script>
